<!doctype html>
<html ng-app>
  <head>
    <script src="/socket.io/socket.io.js"></script>
	<script type='text/javascript' src='knockout-2.1.0.js'></script>
	<link type="text/css" rel="stylesheet" href="./css.css">	
	<link type="text/css" href="jquery/css/le-frog/jquery-ui-1.8.22.custom.css" rel="stylesheet" />
	<script type="text/javascript" src="jquery/js/jquery-1.7.2.min.js"></script>
	<script type="text/javascript" src="jquery/js/jquery-ui-1.8.22.custom.min.js"></script>
		
  </head>
  
  <body>
	<div>Node side status: <strong data-bind="text: agentStatusText"></strong></div>  
  	<div id=runNow style="visibility: hidden;" onClick="runNow()">Run now</div>
	
	<div id=watchToggle style="visibility: hidden;">
		<input type="radio" id="watchToggleOn" name="radio" />
		<label for="watchToggleOn">ON</label>
		<input type="radio" id="watchToggleOff" name="radio" />
		<label for="watchToggleOff">OFF</label>
	</div>
		
	<div id="Console">
		<p>Console output:</p>
		<div id="ConsoleStdout" style="height:250px; overflow:auto;" data-bind="text: agentStdout"></div>
	</div>	
	<!--div id="Console"></div-->
  </body>

  <script>
		$('#runNow').button();
		$('#watchToggle').buttonset();

		var watch;
		var relayedStdout='';
		
		function watchToggle()
		{
			switch(this.id)
			{
				case "watchToggleOn":
					socket.emit('resume', { runParams: 'none' });	
					watch = true;
					break;
				case "watchToggleOff":
					socket.emit('pause', { runParams: 'none' });
					watch = false;				
					break;				
			}
		}
		
		function setWatchToggleButton(watch)
		{
			var selected;
			document.getElementById('watchToggle').style.visibility='visible';
			document.getElementById('watchToggleOn').onclick=watchToggle;
			document.getElementById('watchToggleOff').onclick=watchToggle;			
			
			if (watch)
				selected = document.getElementById('watchToggleOn');
			else
				selected = document.getElementById('watchToggleOff');			
			
			selected.click(); // this has a side effect of sending an event to the server
							  // which is not necessary in this context
		}
		
		var socket = io.connect('http://localhost:1337');
			
		socket.on('agentStatus', function (SRVagentStatus) {
			//alert('got agentStatus message: ' + SRVagentStatus);
			if (SRVagentStatus) 
			{ 
				myViewModel.agentStatusText('running') 
				document.getElementById('runNow').style.visibility='hidden';							
			}
			else 
			{ 
				myViewModel.agentStatusText('not running') 
				document.getElementById('runNow').style.visibility='visible';							
			}
		});
		
		socket.on('agentStarted', function () {
			//relayedStdout += 'Node started...\n';			
		});
		
		
		socket.on('watchStatus', function(status) {
			setWatchToggleButton(status);
		});
		
		socket.on('agentStdout', function (data) {
			{ 
				// append stdout and scroll to bottom of stdout display			
				relayedStdout += data;
				myViewModel.agentStdout(relayedStdout) 
				objDiv = document.getElementById('ConsoleStdout');
				objDiv.scrollTop = objDiv.scrollHeight;		
			}
		});
		
		socket.on('agentStderr', function (data) {
			{ 
				// append stdout and scroll to bottom of stdout display			
				relayedStdout += 'Stderr: ' + data;
				myViewModel.agentStdout(relayedStdout) 
				objDiv = document.getElementById("ConsoleStdout");
				objDiv.scrollTop = objDiv.scrollHeight;		
			}
		});
			
		// Create some observables, and bind them to the page (all with knockout.js).
		var myViewModel = {
			agentStatusText: ko.observable('getting status...'),
			agentStdout: ko.observable(relayedStdout)
		} 
		ko.applyBindings(myViewModel); 
						
		function runNow() { 
			//myViewModel.agentStatusText('run request sent');
			socket.emit('runNow', { runParams: 'none' });
		};
		
	</script>
</html>